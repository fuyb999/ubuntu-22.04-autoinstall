#cloud-config
# Based on https://www.molnar-peter.hu/en/ubuntu-jammy-netinstall-pxe.html
autoinstall:
  identity:
    hostname: jammy-desktop-crypt
    # The following credentials have no effect - the user will be set up by gnome-initial-setup
    password: $6$5lpwCLsKLEzMkSJc$keOAhA6aO/5RocGThmhVA7LSNuW911Rx5HHXFEa75oGK20cEdAAgn14H5f5nGeq6QgcSyLPrWcg1.JvjXbhrN/
    realname: Ubuntu user
    username: ubuntu
  refresh-installer:
    update: no
  keyboard:
    layout: gb
    toggle: null
    variant: ''
  locale: en_GB.UTF-8
  storage:
    config:
    - { ptable: gpt, size: largest, wipe: superblock, preserve: false, name: '', grub_device: false, type: disk, id: disk-vda }
    - { device: disk-vda, size: 50M, wipe: superblock, flag: boot, number: 1, preserve: false, grub_device: true, type: partition, id: partition-efi }
    - { fstype: fat32, volume: partition-efi, preserve: false, type: format, id: format-efi }
    - { device: disk-vda, size: 10G, wipe: superblock, flag: '', number: 2, preserve: false, grub_device: false, type: partition, id: partition-boot }
    - { fstype: ext4, volume: partition-boot, preserve: false, type: format, id: format-boot }
    - { device: disk-vda, size: -1, wipe: superblock, flag: '', number: 3, preserve: false, grub_device: false, type: partition, id: partition-root }
    # DM crypt - unlike the credentials above, this key does get used:
    - { volume: partition-root, key: 'ubuntu', preserve: false, type: dm_crypt, id: dm_crypt-0 }
    - { name: ubuntu-vg, devices: [ dm_crypt-0 ], preserve: false, type: lvm_volgroup, id: lvm_volgroup-0 }
    - { name: ubuntu-lv, volgroup: lvm_volgroup-0, size: -1, wipe: superblock, preserve: false, type: lvm_partition, id: lvm_partition-0 }
    - { fstype: ext4, volume: lvm_partition-0, preserve: false, type: format, id: format-root }
    - { path: /, device: format-root, type: mount, id: mount-2 }
    - { path: /boot, device: format-boot, type: mount, id: mount-1 }
    - { path: /boot/efi, device: format-efi, type: mount, id: mount-0 }
    swap:
      swap: 1G
    grub:
      # This avoids a loop where we autoinstall, reboot to the autoinstaller USB, then autoinstall again and so on.
      reorder_uefi: False
  early-commands:
  - apt install -y mokutil efibootmgr
  - dpkg -i /cdrom/packages-for-in-livecd/*.deb
  - mount > /tmp/early-mount.txt
  - mokutil --sb-state > /tmp/early-mokutil.txt 2>&1 || true
  late-commands:
  - mkdir /target/cdrom
  - mount --bind /cdrom /target/cdrom
  - curtin in-target --target=/target -- sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT=""/GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"/' /etc/default/grub
  - curtin in-target --target=/target -- bash -c 'apt-get purge -y $(cat /cdrom/packages-to-purge.txt)'
  - curtin in-target --target=/target -- dpkg -i /cdrom/packages-to-install/*.deb
  - echo "Europe/London" > /target/etc/timezone
  - umount /target/cdrom
  - rm -r /target/cdrom
  - mv /tmp/early-mount.txt /target/
  - mv /tmp/early-mokutil.txt /target/
  - bootctl status > /target/late-bootctl-status.txt
  - efibootmgr -v > /target/late-efibootmgr.txt
  - ls /sys/class/net/* > /target/late-net1.txt
  - echo "Echo to console!" > /dev/console
  - read x < /dev/console
  version: 1
