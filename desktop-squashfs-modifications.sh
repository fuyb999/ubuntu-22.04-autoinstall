#!/bin/bash

set -euxo pipefail

if ! ischroot -t; then
  echo "This script is intended to run within a chroot, to modify a squashfs image."
  exit 1
fi

export DEBIAN_FRONTEND=noninteractive

# Convert the full-fat desktop install into the minimal desktop:-
apt-get purge -y libreoffice-l10n-en-gb libm17n-0 libreoffice-l10n-en-za liborcus-parser-0.17-0 cifs-utils reiserfsprogs mythes-en-au libyajl2 mythes-en-us libreoffice-calc liblirc-client0 libgpgmepp6 zsys libexttextcat-2.0-0 libreoffice-gnome wspanish uno-libs-private libreoffice-base-core libreoffice-pdfimport shotwell-common language-pack-de-base gnome-sudoku libmarisa0 libgnome-games-support-common language-pack-gnome-ru-base libreoffice-core libepubgen-0.1-1 libraptor2-0 libabw-0.1-1 libopencc1.1 libsuitesparseconfig5 language-pack-gnome-fr-base libetonyek-0.1-1 casper ubiquity-casper zfs-zed usb-creator-common python3-monotonic gnome-todo-common libdmapsharing-3.0-2 libe-book-0.1-1 libboost-iostreams1.74.0 wbrazilian language-pack-gnome-it-base libgnome-todo dctrl-tools libreoffice-common zfs-initramfs python3-lib2to3 hunspell-de-ch-frami libnvpair3linux libnatpmp1 mozc-server ure hunspell-es hunspell-fr hunspell-it hunspell-ru hyphen-en-ca libgpod4 libtimezonemap-data hyphen-en-gb hyphen-en-us python3-lockfile libclucene-contribs1v5 deja-dup ibus-mozc libchewing3-data adcli librdf0 ubiquity-slideshow-ubuntu remmina-plugin-rdp usb-creator-gtk liblangtag-common gtk-im-libthai baobab remmina-plugin-vnc libuutil3linux ibus-libpinyin liblua5.3-0 ibus-table-cangjie3 ibus-table-cangjie5 dmraid libreoffice-draw thunderbird transmission-gtk wfrench libzpool5linux gir1.2-udisks-2.0 totem-common rhythmbox-plugins genisoimage language-pack-es-base thunderbird-locale-pt-br thunderbird-locale-pt-pt xfsprogs mythes-de-ch language-pack-gnome-de-base libwpd-0.10-10 language-pack-de language-pack-es language-pack-fr language-pack-it language-pack-pt language-pack-ru libuno-purpenvhelpergcc3-3 gir1.2-rb-3.0 lp-solve libclucene-core1v5 libreoffice-help-pt-br libuno-cppu3 libodfgen-0.1-1 libgpod-common libboost-filesystem1.74.0 aisleriot libboost-thread1.74.0 libreoffice-impress wngerman hunspell-de-at-frami language-pack-zh-hans gnome-calendar libreoffice-l10n-de libreoffice-l10n-es libreoffice-l10n-fr libreoffice-l10n-it libreoffice-l10n-pt libreoffice-l10n-ru libuno-cppuhelpergcc3-3 gir1.2-gst-plugins-base-1.0 remmina-plugin-secret gir1.2-gudev-1.0 librsync2 language-pack-pt-base libtotem0 gir1.2-timezonemap-1.0 dpkg-repack witalian remmina fonts-arphic-uming libcdr-0.1-1 libgom-1.0-0 gnome-mines libreoffice-l10n-pt-br libpagemaker-0.0-0 libmhash2 libdebian-installer4 thunderbird-locale-zh-cn thunderbird-locale-zh-tw mythes-pt-pt dbus-x11 rhythmbox libxmlsec1 ibus-hangul libboost-locale1.74.0 libfile-fcntllock-perl libreoffice-help-zh-cn libsgutils2-2 totem-plugins libreoffice-help-zh-tw thunderbird-locale-de thunderbird-locale-en thunderbird-locale-es thunderbird-locale-fr libhangul1 thunderbird-locale-it thunderbird-locale-pt thunderbird-locale-ru libreoffice-style-colibre gparted libavahi-ui-gtk3-0 libvncclient1 gir1.2-totem-1.0 libwps-0.4-4 gstreamer1.0-gtk3 libreoffice-writer python3-mako hunspell-en-au hunspell-en-ca duplicity hunspell-en-gb hunspell-en-za hunspell-de-de-frami libuno-salhelpergcc3-3 libreoffice-l10n-zh-cn libreoffice-l10n-zh-tw mythes-de mythes-es mythes-fr wswiss mythes-it liborcus-0.17-0 mythes-ru libreoffice-style-breeze gnome-mahjongg libgrilo-0.3-0 language-pack-gnome-es-base keyutils python3-fasteners libdazzle-common libgnome-games-support-1-3 libreoffice-help-de libreoffice-help-es libreoffice-help-fr libreoffice-help-it libreoffice-help-pt libreoffice-help-ru libcolamd2 ibus-unikey libchewing3 libpinyin13 ibus-table-cangjie-big libevent-2.1-7 libhangul-data finalrd liblangtag1 libtimezonemap1 language-pack-gnome-zh-hans python3-markupsafe python3-icu hyphen-pt-br user-setup ubiquity-frontend-gtk hyphen-pt-pt libmwaw-0.3-3 language-pack-gnome-pt-base libpinyin-data libminiupnpc17 libdmraid1.0.0.rc16 gnome-user-docs-zh-hans python3-pam libreoffice-help-common librevenge-0.0-0 guile-2.2-libs ibus-chewing libdpkg-perl python3-uno gnome-user-docs-de gnome-user-docs-es gnome-user-docs-fr gnome-user-docs-it cheese gnome-user-docs-pt gnome-user-docs-ru rhythmbox-plugin-alternative-toolbar m17n-db libuno-sal3 btrfs-progs libreoffice-ogltrans gnome-video-effects simple-scan rdate thunderbird-locale-zh-hans thunderbird-locale-zh-hant libotf1 language-pack-gnome-de language-pack-gnome-es language-pack-gnome-fr language-pack-gnome-it language-pack-gnome-pt transmission-common language-pack-gnome-ru grilo-plugins-0.3-base language-pack-zh-hans-base libmythes-1.2-0 libdazzle-1.0-0 libvisio-0.1-1 jfsutils ibus-table-wubi gparted-common thunderbird-locale-es-ar thunderbird-locale-es-es libreoffice-style-yaru media-player-info fonts-arphic-ukai libzfs4linux mozc-data hunspell-fr-classical librasqal3 ubiquity-ubuntu-artwork gir1.2-totemplparser-1.0 libqqwing2v5 language-pack-ru-base python3-bcrypt wportuguese libreoffice-math ibus-table-cangjie libmessaging-menu0 libreoffice-gtk3 libexttextcat-data libraw20 language-pack-fr-base libfreehand-0.1-1 remmina-common librhythmbox-core10 libgc1 ibus-m17n realmd branding-ubuntu thunderbird-locale-en-gb thunderbird-locale-en-us libxmlsec1-nss language-pack-gnome-zh-hans-base language-pack-it-base libwpg-0.3-3 ubiquity shotwell libreoffice-help-en-gb gnome-todo libreoffice-help-en-us gir1.2-xkl-1.0 libeot0 kpartx libreoffice-style-elementary libmspub-0.1-1 totem ibus-table-quick-classic python3-future rhythmbox-data wogerman kpartx-boot python3-paramiko thunderbird-gnome-support zfsutils-linux libopencc-data hyphen-de hyphen-es hyphen-fr hyphen-it hyphen-ru hunspell-pt-br hunspell-pt-pt libdhash1 libini-config5 libcollection4 libc-ares2 libref-array1 sssd-proxy libbasicobjects0 sssd-ad-common sssd-ipa ldap-utils libipa-hbac0 libpath-utils1 sssd-krb5-common libsss-nss-idmap0 python3-sss sssd libnss-sss sssd-krb5 libsss-idmap0 sssd-ad libnfsidmap1 sssd-common sssd-ldap libsss-certmap0

# Ensure we get a fancy GUI boot
sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT=""/GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"/' /etc/default/grub

# Install the latest kernel
apt-get update
apt-get install -y linux-generic-hwe-22.04
apt-get upgrade -y

# Clean up the image
apt clean
rm -rf /tmp/* ~/.bash_history /var/lib/apt/lists/*
rm /var/lib/dbus/machine-id || true
